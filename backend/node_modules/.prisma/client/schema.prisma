generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
  engineType    = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  name          String
  password      String
  role          UserRole       @default(STUDENT)
  age           Int?
  weight        Float?
  height        Float?
  canSwim       Boolean        @default(false)
  injuries      String?
  phone         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  profilePhoto  String?
  avatar        String? // Predefined avatar identifier (e.g., 'wave1', 'surf1')
  instructor    Instructor?
  refreshTokens RefreshToken[]
  reservations  Reservation[]
  student       Student?
  notifications Notification[]

  @@map("users")
}

model Instructor {
  id              Int                @id @default(autoincrement())
  userId          Int                @unique
  schoolId        Int
  bio             String?
  yearsExperience Int                @default(0)
  specialties     String[]
  certifications  String[]
  rating          Float              @default(0)
  totalReviews    Int                @default(0)
  profileImage    String?
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  instructorRole  InstructorRole     @default(INSTRUCTOR)
  reviews         InstructorReview[]
  school          School             @relation(fields: [schoolId], references: [id])
  user            User               @relation(fields: [userId], references: [id])

  @@map("instructors")
}

model InstructorReview {
  id           Int        @id @default(autoincrement())
  instructorId Int
  studentName  String
  rating       Int
  comment      String?
  createdAt    DateTime   @default(now())
  instructor   Instructor @relation(fields: [instructorId], references: [id])

  @@map("instructor_reviews")
}

model SchoolReview {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  studentName String
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())
  school      School   @relation(fields: [schoolId], references: [id])

  @@map("school_reviews")
}

model Student {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  schoolId  Int?
  birthdate DateTime?
  notes     String?
  level     ClassLevel @default(BEGINNER)
  canSwim   Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  school    School?    @relation(fields: [schoolId], references: [id])
  user      User       @relation(fields: [userId], references: [id])

  @@map("students")
}

model School {
  id            Int            @id @default(autoincrement())
  name          String
  location      String
  description   String?
  phone         String?
  email         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  address       String?
  coverImage    String?
  facebook      String?
  instagram     String?
  logo          String?
  website       String?
  whatsapp      String?
  ownerId       Int?
  foundedYear   Int?
  rating        Float          @default(0)
  totalReviews  Int            @default(0)
  classes       Class[]
  instructors   Instructor[]
  reviews       SchoolReview[]
  students      Student[]
  notes         CalendarNote[]
  discountCodes DiscountCode[]
  products      Product[]
  status        SchoolStatus   @default(PENDING)

  @@map("schools")
}

model Beach {
  id          Int      @id @default(autoincrement())
  name        String
  location    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  classes     Class[]

  @@map("beaches")
}

model Class {
  id             Int           @id @default(autoincrement())
  title          String
  description    String?
  duration       Int           @default(120)
  defaultPrice   Float         @default(0) // Renamed from price to clarify it's the base price
  level          ClassLevel    @default(BEGINNER)
  schoolId       Int
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?
  instructor     String?
  studentDetails String?
  images         String[]
  beachId        Int?
  beach          Beach?        @relation(fields: [beachId], references: [id])
  school         School        @relation(fields: [schoolId], references: [id])
  reservations   Reservation[]

  // Product settings
  type            String @default("SURF_LESSON")
  defaultCapacity Int    @default(8)

  // Scheduling & Inventory
  schedules ClassSchedule[] // Recurrence rules
  sessions  ClassSession[] // Specific instances

  @@map("classes")
}

model ClassSchedule {
  id        Int     @id @default(autoincrement())
  classId   Int
  dayOfWeek Int // 0-6 (Sunday to Saturday)
  startTime String // "HH:mm"
  endTime   String? // Optional "HH:mm"
  isActive  Boolean @default(true)
  class     Class   @relation(fields: [classId], references: [id])

  @@map("class_schedules")
}

model ClassSession {
  id       Int      @id @default(autoincrement())
  classId  Int
  date     DateTime // Specific date
  time     String // Specific time "HH:mm"
  capacity Int // Total slots for this session
  price    Float? // Optional price override
  isClosed Boolean  @default(false)

  class     Class    @relation(fields: [classId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, date, time])
  @@map("class_sessions")
}

model Reservation {
  id             Int               @id @default(autoincrement())
  userId         Int
  classId        Int
  status         ReservationStatus @default(PENDING)
  specialRequest String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  participants   Json?
  payment        Payment?
  class          Class             @relation(fields: [classId], references: [id])
  user           User              @relation(fields: [userId], references: [id])

  // Products purchased with reservation
  productPurchases ProductPurchase[]

  // Specifics for Recurring Bookings
  date DateTime? // The specific date booked
  time String? // The specific time slot booked

  @@map("reservations")
}

model Payment {
  id             Int           @id @default(autoincrement())
  reservationId  Int           @unique
  amount         Float
  status         PaymentStatus @default(UNPAID)
  paymentMethod  String?
  transactionId  String?
  paidAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  voucherImage   String?
  voucherNotes   String?
  discountCodeId Int?
  discountAmount Float?
  originalAmount Float? // Monto original antes del descuento
  reservation    Reservation   @relation(fields: [reservationId], references: [id])
  discountCode   DiscountCode? @relation(fields: [discountCodeId], references: [id])

  @@map("payments")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  tokenHash String
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("refresh_tokens")
}

model Product {
  id          Int      @id @default(autoincrement())
  schoolId    Int
  name        String
  description String?
  price       Float
  currency    String   @default("PEN")
  stock       Int      @default(0)
  image       String?
  category    String? // "EQUIPMENT", "MERCH", "FOOD"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school    School            @relation(fields: [schoolId], references: [id])
  purchases ProductPurchase[]

  @@map("products")
}

model ProductPurchase {
  id            Int      @id @default(autoincrement())
  reservationId Int
  productId     Int
  quantity      Int
  unitPrice     Float // Precio al momento de la compra
  totalPrice    Float
  createdAt     DateTime @default(now())

  reservation Reservation @relation(fields: [reservationId], references: [id])
  product     Product     @relation(fields: [productId], references: [id])

  @@map("product_purchases")
}

enum UserRole {
  STUDENT
  ADMIN
  SCHOOL_ADMIN
  INSTRUCTOR
}

enum ClassLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  PAID
  CANCELED
  COMPLETED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  PENDING
}

enum InstructorRole {
  INSTRUCTOR
  HEAD_COACH
}

enum SchoolStatus {
  PENDING
  APPROVED
  REJECTED
}

model CalendarNote {
  id        Int      @id @default(autoincrement())
  schoolId  Int
  title     String
  content   String?
  date      DateTime
  time      String? // Hora específica (formato HH:mm)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id])

  @@map("calendar_notes")
}

model DiscountCode {
  id                 Int       @id @default(autoincrement())
  code               String    @unique
  description        String?
  discountPercentage Float // Porcentaje de descuento (0-100)
  validFrom          DateTime // Fecha de inicio de validez
  validTo            DateTime // Fecha de fin de validez
  isActive           Boolean   @default(true)
  maxUses            Int? // Número máximo de usos (null = ilimitado)
  usedCount          Int       @default(0)
  schoolId           Int? // null = código global (admin), número = código específico de escuela
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  school             School?   @relation(fields: [schoolId], references: [id])
  payments           Payment[]

  @@map("discount_codes")
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType // EMAIL, WHATSAPP, SYSTEM
  category  String // RESERVATION_CONFIRMED, etc.
  subject   String?
  content   String           @db.Text // Store full HTML
  metadata  Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id])

  @@map("notifications")
}

enum NotificationType {
  EMAIL
  WHATSAPP
  SYSTEM
}
