name: ğŸš€ Deploy to Railway

on:
  push:
    branches: [main, production]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BACKEND: ${{ github.repository }}-backend
  IMAGE_NAME_FRONTEND: ${{ github.repository }}-frontend
  RAILWAY_PROJECT_ID: 5b9527ff-cf02-405e-989f-f1120848d679

jobs:
  # Job 1: Build and Test
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ” Lint Backend
        working-directory: ./backend
        run: npm run lint || true

      - name: ğŸ” Lint Frontend
        working-directory: ./frontend
        run: npm run lint || true

      - name: ğŸ§ª Test Backend
        working-directory: ./backend
        run: npm test || true

      - name: ğŸ§ª Test Frontend
        working-directory: ./frontend
        run: npm test || true

      - name: ğŸ—ï¸ Build Backend
        working-directory: ./backend
        run: npm run build

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./frontend
        run: npm run build

  # Job 2: Deploy to Railway
  deploy-railway:
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš‚ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸš€ Deploy Backend to Railway
        id: deploy-backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ env.RAILWAY_PROJECT_ID }}
          CI: true
        working-directory: ./backend
        run: railway up --service backend --detach || (echo "FAILED_BACKEND=true" >> $GITHUB_ENV && exit 1)

      - name: ğŸ” Diagnose Railway Services
        if: failure()
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ env.RAILWAY_PROJECT_ID }}
          CI: true
        run: |
          echo "Listing available services in project..."
          railway status

      - name: ğŸš€ Deploy Frontend to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ env.RAILWAY_PROJECT_ID }}
          CI: true
        working-directory: ./frontend
        run: railway up --service frontend --detach

      - name: â³ Wait for deployment
        run: sleep 60

      - name: ğŸ” Verify deployment
        id: verify
        run: |
          # AquÃ­ puedes agregar scripts de verificaciÃ³n
          echo "Deployment verification would go here"
          echo "url=https://your-app.railway.app" >> $GITHUB_OUTPUT

  # Job 4: Run Database Migrations
  migrate-database:
    needs: deploy-railway
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš‚ Install Railway CLI
        run: npm install -g @railway/cli

      - name: ğŸ—„ï¸ Run Database Migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ env.RAILWAY_PROJECT_ID }}
          CI: true
        working-directory: ./backend
        run: railway run --service backend npx prisma migrate deploy

      - name: ğŸŒ± Seed Database (if needed)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ env.RAILWAY_PROJECT_ID }}
          CI: true
        working-directory: ./backend
        run: railway run --service backend npx prisma db seed || echo "Seeding skipped or failed"

  # Job 5: Notify Success
  notify:
    needs: [deploy-railway, migrate-database]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š Deployment Status
        run: |
          if [ "${{ needs.deploy-railway.result }}" == "success" ] && [ "${{ needs.migrate-database.result }}" == "success" ]; then
            echo "ğŸ‰ Deployment successful!"
            echo "âœ… Backend deployed"
            echo "âœ… Frontend deployed"
            echo "âœ… Database migrated"
          else
            echo "âŒ Deployment failed"
            echo "Backend: ${{ needs.deploy-railway.result }}"
            echo "Database: ${{ needs.migrate-database.result }}"
          fi

    # Opcional: Notificar a Slack, Discord, etc.
    # - name: ğŸ“¢ Notify Slack
    #   if: always()
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
